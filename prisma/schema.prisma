generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Plano {
  TRIAL
  BASICO
  PROFISSIONAL
  PREMIUM
}

enum TipoNegocio {
  LANCAMENTO
  TERCEIROS
}

enum EtapaKanban {
  NOVO_LEAD
  PRIMEIRO_CONTATO
  QUALIFICADO
  VISITA_AGENDADA
  PROPOSTA_ENVIADA
  FECHAMENTO
  VENDIDO
  PERDIDO
}

enum TipoTransacao {
  RECEITA
  DESPESA
}

enum StatusTransacao {
  PENDENTE
  PAGO
  ATRASADO
  CANCELADO
}

enum TipoAgente {
  ALYA_COACH
  GERADOR_MENSAGEM
  QUALIFICADOR
}

enum TipoAtividade {
  LIGACAO
  WHATSAPP
  EMAIL
  VISITA
  REUNIAO
  PROPOSTA
  OUTRO
}

enum StatusEmpreendimento {
  FUTURO_LANCAMENTO
  EM_CONSTRUCAO
  PRONTO
}

enum StatusUnidade {
  DISPONIVEL
  RESERVADO
  VENDIDO
  BLOQUEADO
}

enum TipoImovelUsado {
  APARTAMENTO
  CASA
  TERRENO
  SALA_COMERCIAL
  COBERTURA
  LOFT
}

enum Documentacao {
  ESCRITURADO
  FINANCIADO
  INVENTARIO
  IRREGULAR
}

enum PosicaoSolar {
  NASCENTE
  POENTE
  NORTE
  SUL
}

model Usuario {
  id           Int      @id @default(autoincrement())
  nome         String   @db.VarChar(255)
  email        String   @unique @db.VarChar(255)
  senhaHash    String   @map("senha_hash") @db.VarChar(255)
  telefone     String?  @db.VarChar(20)
  creci        String?  @db.VarChar(50)
  plano        Plano    @default(TRIAL)
  avatar       String?  @db.VarChar(500)
  criadoEm     DateTime @default(now()) @map("criado_em")
  atualizadoEm DateTime @updatedAt @map("atualizado_em")

  leads          Lead[]
  imoveis        Imovel[]
  negociacoes    Negociacao[]
  transacoes     TransacaoFinanceira[]
  empreendimentos Empreendimento[]
  imoveisUsados  ImovelUsado[]
  conversasAlya  ConversaAlya[]

  @@map("usuarios")
}

model Lead {
  id                Int      @id @default(autoincrement())
  usuarioId         Int      @map("usuario_id")
  nome              String   @db.VarChar(255)
  telefone          String?  @db.VarChar(20)
  email             String?  @db.VarChar(255)
  origem            String?  @db.VarChar(100)
  perfilComprador   Json?    @map("perfil_comprador")
  scoreQualificacao Int      @default(0) @map("score_qualificacao")
  observacoes       String?  @db.Text
  criadoEm          DateTime @default(now()) @map("criado_em")
  atualizadoEm      DateTime @updatedAt @map("atualizado_em")

  usuario     Usuario      @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  negociacoes Negociacao[]

  @@index([usuarioId])
  @@map("leads")
}

model Imovel {
  id                 Int         @id @default(autoincrement())
  usuarioId          Int         @map("usuario_id")
  tipoNegocio        TipoNegocio @map("tipo_negocio")
  titulo             String      @db.VarChar(255)
  descricao          String?     @db.Text
  valor              Decimal     @db.Decimal(15, 2)
  comissaoPercentual Decimal     @map("comissao_percentual") @db.Decimal(5, 2)
  endereco           String?     @db.VarChar(500)
  cidade             String?     @db.VarChar(100)
  bairro             String?     @db.VarChar(100)
  caracteristicas    Json?
  fotos              Json?
  construtora        String?     @db.VarChar(255)
  nomeProprietario   String?     @map("nome_proprietario") @db.VarChar(255)
  telefoneProprietario String?   @map("telefone_proprietario") @db.VarChar(20)
  ativo              Boolean     @default(true)
  criadoEm           DateTime    @default(now()) @map("criado_em")
  atualizadoEm       DateTime    @updatedAt @map("atualizado_em")

  usuario     Usuario      @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  negociacoes Negociacao[]

  @@index([usuarioId])
  @@index([tipoNegocio])
  @@map("imoveis")
}

model Empreendimento {
  id                 Int                   @id @default(autoincrement())
  usuarioId          Int                   @map("usuario_id")
  nome               String                @db.VarChar(255)
  incorporadora      String?               @db.VarChar(255)
  endereco           String?               @db.VarChar(500)
  cidade             String?               @db.VarChar(100)
  bairro             String?               @db.VarChar(100)
  status             StatusEmpreendimento  @default(EM_CONSTRUCAO)
  dataLancamento     DateTime?             @map("data_lancamento") @db.Date
  dataEntrega        DateTime?             @map("data_entrega") @db.Date
  comissaoPercentual Decimal               @default(5.0) @map("comissao_percentual") @db.Decimal(5, 2)
  descricao          String?               @db.Text
  caracteristicas    Json?
  fotos              Json?
  ativo              Boolean               @default(true)
  criadoEm           DateTime              @default(now()) @map("criado_em")
  atualizadoEm       DateTime              @updatedAt @map("atualizado_em")

  usuario    Usuario     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  torres     Torre[]
  tipologias Tipologia[]

  @@index([usuarioId])
  @@index([status])
  @@map("empreendimentos")
}

model Torre {
  id               Int      @id @default(autoincrement())
  empreendimentoId Int      @map("empreendimento_id")
  nome             String   @db.VarChar(100)
  totalAndares     Int      @map("total_andares")
  unidadesPorAndar Int      @map("unidades_por_andar")
  criadoEm         DateTime @default(now()) @map("criado_em")
  atualizadoEm     DateTime @updatedAt @map("atualizado_em")

  empreendimento Empreendimento @relation(fields: [empreendimentoId], references: [id], onDelete: Cascade)
  unidades       Unidade[]

  @@index([empreendimentoId])
  @@map("torres")
}

model Tipologia {
  id               Int      @id @default(autoincrement())
  empreendimentoId Int      @map("empreendimento_id")
  nome             String   @db.VarChar(100)
  areaPrivativa    Decimal  @map("area_privativa") @db.Decimal(10, 2)
  quartos          Int      @default(0)
  suites           Int      @default(0)
  vagas            Int      @default(0)
  precoBase        Decimal  @map("preco_base") @db.Decimal(15, 2)
  diferenciais     Json?
  criadoEm         DateTime @default(now()) @map("criado_em")
  atualizadoEm     DateTime @updatedAt @map("atualizado_em")

  empreendimento Empreendimento @relation(fields: [empreendimentoId], references: [id], onDelete: Cascade)
  unidades       Unidade[]

  @@index([empreendimentoId])
  @@map("tipologias")
}

model Unidade {
  id           Int           @id @default(autoincrement())
  torreId      Int           @map("torre_id")
  tipologiaId  Int?          @map("tipologia_id")
  codigo       String        @db.VarChar(20)
  andar        Int
  posicao      String        @db.VarChar(10)
  posicaoSolar PosicaoSolar? @map("posicao_solar")
  preco        Decimal?      @db.Decimal(15, 2)
  precoM2      Decimal?      @map("preco_m2") @db.Decimal(15, 2)
  status       StatusUnidade @default(DISPONIVEL)
  extras       Json?
  criadoEm     DateTime      @default(now()) @map("criado_em")
  atualizadoEm DateTime      @updatedAt @map("atualizado_em")

  torre       Torre       @relation(fields: [torreId], references: [id], onDelete: Cascade)
  tipologia   Tipologia?  @relation(fields: [tipologiaId], references: [id], onDelete: SetNull)
  negociacoes Negociacao[]

  @@unique([torreId, codigo])
  @@index([torreId])
  @@index([tipologiaId])
  @@index([status])
  @@map("unidades")
}

model ImovelUsado {
  id                   Int             @id @default(autoincrement())
  usuarioId            Int             @map("usuario_id")
  tipoImovel           TipoImovelUsado @map("tipo_imovel")
  titulo               String          @db.VarChar(255)
  descricao            String?         @db.Text
  endereco             String?         @db.VarChar(500)
  cidade               String?         @db.VarChar(100)
  bairro               String?         @db.VarChar(100)
  areaUtil             Decimal?        @map("area_util") @db.Decimal(10, 2)
  areaTotal            Decimal?        @map("area_total") @db.Decimal(10, 2)
  quartos              Int             @default(0)
  suites               Int             @default(0)
  vagas                Int             @default(0)
  valorAvaliacao       Decimal?        @map("valor_avaliacao") @db.Decimal(15, 2)
  valorVenda           Decimal         @map("valor_venda") @db.Decimal(15, 2)
  comissaoPercentual   Decimal         @default(6.0) @map("comissao_percentual") @db.Decimal(5, 2)
  documentacao         Documentacao    @default(ESCRITURADO)
  nomeProprietario     String?         @map("nome_proprietario") @db.VarChar(255)
  telefoneProprietario String?         @map("telefone_proprietario") @db.VarChar(20)
  emailProprietario    String?         @map("email_proprietario") @db.VarChar(255)
  caracteristicas      Json?
  fotos                Json?
  ativo                Boolean         @default(true)
  criadoEm             DateTime        @default(now()) @map("criado_em")
  atualizadoEm         DateTime        @updatedAt @map("atualizado_em")

  usuario     Usuario      @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  negociacoes Negociacao[]

  @@index([usuarioId])
  @@index([tipoImovel])
  @@map("imoveis_usados")
}

model Negociacao {
  id              Int          @id @default(autoincrement())
  usuarioId       Int          @map("usuario_id")
  leadId          Int          @map("lead_id")
  imovelId        Int?         @map("imovel_id")
  unidadeId       Int?         @map("unidade_id")
  imovelUsadoId   Int?         @map("imovel_usado_id")
  etapaKanban     EtapaKanban  @default(NOVO_LEAD) @map("etapa_kanban")
  valorProposta   Decimal?     @map("valor_proposta") @db.Decimal(15, 2)
  observacoes     String?      @db.Text
  proximoContato  DateTime?    @map("proximo_contato")
  ordem           Int          @default(0)
  criadoEm        DateTime     @default(now()) @map("criado_em")
  atualizadoEm    DateTime     @updatedAt @map("atualizado_em")

  usuario      Usuario       @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  lead         Lead          @relation(fields: [leadId], references: [id], onDelete: Cascade)
  imovel       Imovel?       @relation(fields: [imovelId], references: [id], onDelete: SetNull)
  unidade      Unidade?      @relation(fields: [unidadeId], references: [id], onDelete: SetNull)
  imovelUsado  ImovelUsado?  @relation(fields: [imovelUsadoId], references: [id], onDelete: SetNull)
  historicosIA HistoricoIA[]
  atividades   Atividade[]
  transacoes   TransacaoFinanceira[]

  @@index([usuarioId])
  @@index([etapaKanban])
  @@index([unidadeId])
  @@index([imovelUsadoId])
  @@map("negociacoes")
}

model TransacaoFinanceira {
  id             Int             @id @default(autoincrement())
  usuarioId      Int             @map("usuario_id")
  negociacaoId   Int?            @map("negociacao_id")
  tipo           TipoTransacao
  categoria      String          @db.VarChar(100)
  descricao      String?         @db.VarChar(255)
  valor          Decimal         @db.Decimal(15, 2)
  dataVencimento DateTime?       @map("data_vencimento") @db.Date
  dataPagamento  DateTime?       @map("data_pagamento") @db.Date
  status         StatusTransacao @default(PENDENTE)
  recorrente     Boolean         @default(false)
  criadoEm       DateTime        @default(now()) @map("criado_em")

  usuario    Usuario     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  negociacao Negociacao? @relation(fields: [negociacaoId], references: [id], onDelete: SetNull)

  @@index([usuarioId])
  @@index([tipo])
  @@index([status])
  @@map("transacoes_financeiras")
}

model HistoricoIA {
  id           Int        @id @default(autoincrement())
  negociacaoId Int        @map("negociacao_id")
  tipoAgente   TipoAgente @map("tipo_agente")
  prompt       String     @db.Text
  resposta     String     @db.Text
  criadoEm     DateTime   @default(now()) @map("criado_em")

  negociacao Negociacao @relation(fields: [negociacaoId], references: [id], onDelete: Cascade)

  @@index([negociacaoId])
  @@map("historicos_ia")
}

model Atividade {
  id           Int           @id @default(autoincrement())
  negociacaoId Int           @map("negociacao_id")
  tipo         TipoAtividade
  descricao    String        @db.Text
  dataAtividade DateTime     @map("data_atividade")
  concluida    Boolean       @default(false)
  criadoEm     DateTime      @default(now()) @map("criado_em")

  negociacao Negociacao @relation(fields: [negociacaoId], references: [id], onDelete: Cascade)

  @@index([negociacaoId])
  @@map("atividades")
}

enum TipoConversaAlya {
  QUALIFICACAO
  ASSISTENTE
  SUPORTE
}

enum StatusConversaAlya {
  ATIVA
  PAUSADA
  FINALIZADA
  TRANSFERIDA
}

enum TipoLembrete {
  FOLLOW_UP
  VISITA
  PROPOSTA
  CONTATO
  ANIVERSARIO
  PERSONALIZADO
}

model ConversaAlya {
  id           Int               @id @default(autoincrement())
  usuarioId    Int               @map("usuario_id")
  leadId       Int?              @map("lead_id")
  tipo         TipoConversaAlya  @default(QUALIFICACAO)
  status       StatusConversaAlya @default(ATIVA)
  contexto     String?           @db.VarChar(100)
  perfilColetado Json?           @map("perfil_coletado")
  scoreQualificacao Int?         @map("score_qualificacao")
  criadoEm     DateTime          @default(now()) @map("criado_em")
  atualizadoEm DateTime          @updatedAt @map("atualizado_em")
  finalizadoEm DateTime?         @map("finalizado_em")

  usuario   Usuario          @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  mensagens MensagemAlya[]

  @@index([usuarioId])
  @@index([leadId])
  @@index([status])
  @@map("conversas_alya")
}

model MensagemAlya {
  id          Int      @id @default(autoincrement())
  conversaId  Int      @map("conversa_id")
  remetente   String   @db.VarChar(20)
  conteudo    String   @db.Text
  metadados   Json?
  criadoEm    DateTime @default(now()) @map("criado_em")

  conversa ConversaAlya @relation(fields: [conversaId], references: [id], onDelete: Cascade)

  @@index([conversaId])
  @@map("mensagens_alya")
}

model Lembrete {
  id           Int           @id @default(autoincrement())
  usuarioId    Int           @map("usuario_id")
  leadId       Int?          @map("lead_id")
  negociacaoId Int?          @map("negociacao_id")
  tipo         TipoLembrete
  titulo       String        @db.VarChar(255)
  descricao    String?       @db.Text
  dataLembrete DateTime      @map("data_lembrete")
  lido         Boolean       @default(false)
  acionado     Boolean       @default(false)
  criadoEm     DateTime      @default(now()) @map("criado_em")

  @@index([usuarioId])
  @@index([dataLembrete])
  @@index([lido])
  @@map("lembretes")
}
